Этот документ доступен на других языках:
`English </anpol/win32chcp/src/default/README.rst>`__.

----

**win32chcp** является расширением (надстройкой) для распределённой
системы контроля версий `Mercurial <http://mercurial.selenic.com/>`__.

Цель расширения — помочь пользователям локализованных версий Windows
получать читаемый текст в тех случаях, когда они запускают Mercurial с
консоли Windows.

Установка
---------

Клонируйте репозиторий с исходным кодом расширения win32chcp:

.. code:: sh

    hg clone https://bitbucket.org/anpol/win32chcp

После этого настройте файл
`mercurial.ini <http://www.selenic.com/mercurial/hgrc.5.html>`__,
добавив в него строчку, указывающую на полный путь к файлу расширения.

.. code:: ini

    [extensions]
    win32chcp = C:/путь к расширению/hgext/win32chcp.py

Название пути должно начинаться с буквы диска, разделителем должна быть
прямая косая черта. Заключать путь в кавычки не нужно, даже если путь
содержит пробельные символы.

Чтобы убедиться, что расширение установилось, выполните команду:

.. code:: sh

    hg help win32chcp

Описание проблемы
-----------------

-  `Кодировка символов на Windows <http://mercurial.selenic.com/wiki/CharacterEncodingOnWindows>`__
   *(англ.)* — описывает суть проблемы и предлагает ряд решений.
-  `Стратегия использования кодировок <http://mercurial.selenic.com/wiki/EncodingStrategy>`__
   *(англ.)* — раскрывает некоторые внутренности обработки кодировок в
   Mercurial.

Как это работает
----------------

Расширение переключает кодировку вашей консоли прямо перед тем, как
Mercurial выдаст какой-либо текст. Кодировка будет совпадать с той,
которую Mercurial использует для вывода, поэтому в большинстве случаев
вы увидите на экране по-настоящему читаемый текст.

Предположим, что вы установили **win32chcp** на русской системе Windows,
с настройками по умолчанию. Тогда ваша консоль использует кодировку
cp866, а программы графического интерфейса — кодировку windows-1251 (её
же и использует Mercurial по умолчанию).

Теперь, если вы выполните такие команды:

.. code:: sh

    chcp
    hg
    chcp

результат будет таким:

.. code:: sh

    866
    #-- короткий текст в кодировке windows-1251
    866

Как видите, кодировка обычно *восстанавливается* по завершении процесса
Mercurial. В некоторых случаях восстановление кодировки является
невозможным либо нежелательным:

.. code:: sh

    chcp
    hg help | more
    chcp

Вывод будет таким:

.. code:: sh

    866
    [win32chcp] switching your console encoding into cp1251
    #-- длинный текст
    #-- в кодировке windows-1251,
    #-- пропущенный через `more'
    1251

Команда выдала предупреждение о том, что кодировка консоли изменилась и
останется такой, какую использует Mercurial. Теперь, если вы захотите
восстановить кодировку, вам нужно либо закрыть-открыть консоль, либо
выполнить команду ``chcp 866`` самостоятельно.

Почему так? Потому что процесс ``hg`` завершается слишком рано, в то
время как ``more`` продолжает печатать буферизованный текст. В этом
случае мы просто не знаем, как восстановить кодировку за вас.

Такая логика поведения имеет интересные последствия:

.. code:: sh

    hg help >help.txt
    type help.txt

Даже теперь вы всё равно получите читаемый результат, хотя файл
``help.txt`` имеет кодировку windows-1251.

Мы просто не стали восстанавливать исходную кодировку, по тем же
причинам, что и выше.
